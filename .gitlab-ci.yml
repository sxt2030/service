stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_IMAGE: "maxpack2030/skillbox-app"
  ANSIBLE_HOST_KEY_CHECKING: "False"

# --- Stage 1: Run tests ---
run_tests:
  stage: test
  image: docker:24.0.2
  services:
    - docker:dind
  script:
    - echo "Running tests..."
    - docker build --target test -t test-image ./skillbox-app
    - docker run --rm test-image
  only:
    - uat
  tags:
    - docker

# --- Stage 2: Build image ---
build_image:
  stage: build
  image: docker:24.0.2
  services:
    - docker:dind
  script:
    - echo "Building Docker image..."
    - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_TOKEN"
    - docker build -t "$DOCKER_IMAGE:$CI_COMMIT_REF_NAME" ./skillbox-app
    - docker push "$DOCKER_IMAGE:$CI_COMMIT_REF_NAME"
    - echo "IMAGE_TAG=$CI_COMMIT_REF_NAME" > image_tag.txt
  artifacts:
    paths:
      - image_tag.txt
    reports:
      dotenv: image_tag.txt
  only:
    - uat
  needs:
    - run_tests
  tags:
    - docker

# --- Stage 3: Deploy to UAT ---
deploy_to_uat:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh ansible
    - echo "$ANSIBLE_PRIVATE_KEY" > private_key.pem
    - chmod 600 private_key.pem
    - mkdir -p ~/.ssh
    - ssh-keyscan -H "$APP_SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - echo "Deploying via Ansible to UAT..."
    - ansible-playbook playbooks/deploy_service.yml -i "${APP_SERVER_IP}," -u ubuntu --private-key private_key.pem --extra-vars "service_name=skillbox-app docker_image=${DOCKER_IMAGE} image_tag=${IMAGE_TAG}"
  artifacts:
    reports:
      dotenv: image_tag.txt
  only:
    - uat
  environment:
    name: uat
  needs:
    - build_image

# --- Stage 4: Deploy to Production ---
deploy_to_prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh ansible
    - echo "$ANSIBLE_PRIVATE_KEY" > private_key.pem
    - chmod 600 private_key.pem
    - mkdir -p ~/.ssh
    - ssh-keyscan -H "$PROD_SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - echo "Deploying via Ansible to PROD..."
    - echo "Using image tag $IMAGE_TAG"
    - ansible-playbook playbooks/deploy_service.yml -i "${PROD_SERVER_IP}," -u ubuntu --private-key private_key.pem --extra-vars "service_name=skillbox-app docker_image=${DOCKER_IMAGE} image_tag=${IMAGE_TAG}"
  only:
    - main
  environment:
    name: production
  when: manual
  needs:
    - job: deploy_to_uat
      artifacts: true

